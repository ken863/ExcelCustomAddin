# Makefile for Excel Custom Add-in

.PHONY: help build start stop restart logs clean install proxy-setup docker-build docker-publish docker-run

# Default target
help:
	@echo "Excel Custom Add-in Commands:"
	@echo "  make install         - CÃ i Ä‘áº·t dependencies"
	@echo "  make build          - Build Docker image"
	@echo "  make start          - Khá»Ÿi Ä‘á»™ng add-in server"
	@echo "  make stop           - Dá»«ng add-in server"
	@echo "  make restart        - Restart add-in server"
	@echo "  make logs           - Xem logs real-time"
	@echo "  make clean          - Dá»n dáº¹p containers vÃ  volumes"
	@echo "  make dev            - Cháº¡y á»Ÿ development mode"
	@echo "  make status         - Kiá»ƒm tra tráº¡ng thÃ¡i containers"
	@echo "  make proxy-setup    - Thiáº¿t láº­p cáº¥u hÃ¬nh proxy"
	@echo "  make docker-build   - Build Docker image cho production"
	@echo "  make docker-publish - Build vÃ  publish lÃªn Docker Hub"
	@echo "  make docker-run     - Cháº¡y tá»« published Docker image"

# CÃ i Ä‘áº·t dependencies
install:
	@echo "ğŸ“¦ Installing dependencies..."
	npm install

# Build Docker image
build:
	@echo "ğŸ”¨ Building Docker image..."
	docker-compose build

# Khá»Ÿi Ä‘á»™ng services
start:
	@echo "ğŸš€ Starting Excel Add-in server..."
	docker-compose up -d
	@echo "âœ… Server started at https://localhost:3000"

# Dá»«ng services
stop:
	@echo "â¹ï¸  Stopping Excel Add-in server..."
	docker-compose down

# Restart services
restart:
	@echo "ğŸ”„ Restarting Excel Add-in server..."
	docker-compose restart
	@echo "âœ… Server restarted"

# Xem logs
logs:
	@echo "ğŸ“‹ Showing logs (Ctrl+C to exit)..."
	docker-compose logs -f excel-addin

# Development mode (cháº¡y trá»±c tiáº¿p)
dev:
	@echo "ğŸ› ï¸  Starting development server..."
	npm run dev-server

# Kiá»ƒm tra status
status:
	@echo "ğŸ“Š Container status:"
	docker-compose ps

# Dá»n dáº¹p
clean:
	@echo "ğŸ§¹ Cleaning up containers and volumes..."
	docker-compose down -v
	docker system prune -f

# Setup tá»« Ä‘áº§u
setup: build start
	@echo "ğŸ‰ Setup completed! Add-in is ready at https://localhost:3000"

# Thiáº¿t láº­p proxy
proxy-setup:
	@echo "ğŸ”§ Setting up proxy configuration..."
	@if [ ! -f .env ]; then \
		echo "ğŸ“‹ Creating .env file from template..."; \
		cp .env.example .env; \
		echo "âœ… Created .env file. Please edit it with your proxy settings:"; \
		echo "   - HTTP_PROXY=http://proxy-server:port"; \
		echo "   - HTTPS_PROXY=http://proxy-server:port"; \
		echo "   - NO_PROXY=localhost,127.0.0.1"; \
		echo ""; \
		echo "ğŸ“ Edit .env file: nano .env"; \
	else \
		echo "âœ… .env file already exists"; \
		echo "ğŸ“ Current proxy settings:"; \
		grep -E "^(HTTP_PROXY|HTTPS_PROXY|NO_PROXY)" .env || echo "   No proxy configured"; \
	fi

# Build Docker image cho production
docker-build:
	@echo "ğŸ”¨ Building production Docker image..."
	@export DOCKER_USERNAME=$${DOCKER_USERNAME:-your-username} && \
	docker build \
		--build-arg BUILD_DATE="$(shell date -u +'%Y-%m-%dT%H:%M:%SZ')" \
		--build-arg VCS_REF="$(shell git rev-parse --short HEAD 2>/dev/null || echo 'unknown')" \
		--tag "$$DOCKER_USERNAME/excel-custom-addin:latest" \
		--tag "$$DOCKER_USERNAME/excel-custom-addin:$(shell date +%Y%m%d)" \
		.
	@echo "âœ… Build completed!"

# Build vÃ  publish lÃªn Docker Hub
docker-publish:
	@echo "ğŸš€ Building and publishing to Docker Hub..."
	@if [ -z "$$DOCKER_USERNAME" ]; then \
		echo "âŒ DOCKER_USERNAME environment variable is required"; \
		echo "   Set it with: export DOCKER_USERNAME=your-dockerhub-username"; \
		exit 1; \
	fi
	./build-and-publish.sh

# Cháº¡y tá»« published Docker image
docker-run:
	@echo "ğŸš€ Running from published Docker image..."
	@export DOCKER_USERNAME=$${DOCKER_USERNAME:-your-username} && \
	docker-compose -f docker-compose.prod.yml up -d
	@echo "âœ… Started production container from Docker Hub image"
